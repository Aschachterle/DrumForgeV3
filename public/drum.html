<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/images/logo.png">
    <title>Parametric Drum - Extrudo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "IBM Plex Sans", "Space Grotesk", "Segoe UI", sans-serif;
            background-color: #f6f6f6;
            background-image:
                linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
            background-size: 24px 24px;
            min-height: 100vh;
            padding: 0 32px 32px;
            color: #0a0a0a;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        body.loaded {
            opacity: 1;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            min-height: 50px; /* Prevent layout shift */
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #0a0a0a;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            padding: 8px 16px;
            border: 1px solid #e2e2e2;
            border-radius: 8px;
            background: #ffffff;
            transition: all 0.2s ease;
        }

        .back-link:hover {
            background: #f3f3f3;
            border-color: #0a0a0a;
        }

        .header-logo {
            width: min(140px, 32vw);
            height: auto;
            min-height: 40px; /* Reserve space while loading */
            margin: 0;
            display: block;
            object-fit: contain;
            border: none;
            border-radius: 0;
            padding: 0;
            background: transparent;
        }

        .description {
            color: #4c4c4c;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(320px, 1fr) minmax(320px, 1fr);
            gap: 24px;
        }

        .panel {
            background: #ffffff;
            border: 1px solid #e2e2e2;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.06);
        }

        .panel-header {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #6b6b6b;
            margin-bottom: 20px;
        }

        .section {
            margin-bottom: 26px;
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: #0a0a0a;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #0a0a0a;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #0a0a0a;
            font-size: 11px;
            font-weight: 700;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .upload-hint {
            color: #999;
            font-size: 12px;
        }

        .file-info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-info-text {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .file-name {
            font-weight: 600;
            color: #667eea;
            word-break: break-all;
        }

        .parameters-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            min-height: 320px; /* Prevent layout shift while JS loads parameters */
        }

        .parameter-group {
            display: flex;
            flex-direction: column;
        }

        .parameter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #1c1c1c;
            margin-bottom: 6px;
            cursor: help;
            display: inline-block;
            transition: color 0.2s ease;
        }

        .parameter-group label:hover {
            color: #0a0a0a;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 3px;
        }

        .parameter-group input {
            padding: 10px 12px;
            border: 1px solid #d6d6d6;
            border-radius: 8px;
            font-size: 13px;
            font-family: "IBM Plex Mono", "Menlo", monospace;
            transition: border-color 0.2s ease;
            cursor: help;
        }

        .parameter-group input:focus {
            outline: none;
            border-color: #0a0a0a;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.08);
        }

        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-with-unit input {
            flex: 1;
        }

        .unit-suffix {
            font-size: 13px;
            font-family: "IBM Plex Mono", "Menlo", monospace;
            color: #5a5a5a;
            min-width: 28px;
        }

        .parameter-note {
            font-size: 11px;
            color: #7a7a7a;
            margin-top: 4px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid #0a0a0a;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #0a0a0a;
            color: #ffffff;
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-submit.loading,
        .btn-secondary.loading {
            position: relative;
            color: transparent;
            pointer-events: none;
        }

        .btn-submit.loading::after,
        .btn-secondary.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .btn-submit.loading::after {
            border-top-color: #ffffff;
        }

        .btn-secondary.loading::after {
            border-top-color: #0a0a0a;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-secondary {
            background: #ffffff;
            color: #0a0a0a;
        }

        .btn-secondary:hover {
            background: #f0f0f0;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            font-size: 14px;
        }

        .status.show {
            display: block;
        }

        .status.pending {
            background: #f3f3f3;
            border-left: 4px solid #0a0a0a;
            color: #2a2a2a;
        }

        .status.success {
            background: #f3f3f3;
            border-left: 4px solid #0a0a0a;
            color: #1a1a1a;
        }

        .status.error {
            background: #f3f3f3;
            border-left: 4px solid #0a0a0a;
            color: #1a1a1a;
        }

        .status-text {
            margin-bottom: 10px;
        }

        .status-id {
            font-family: monospace;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.1);
            padding: 5px 10px;
            border-radius: 4px;
            word-break: break-all;
        }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0, 0, 0, 0.12);
            border-top-color: #0a0a0a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress {
            margin-top: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #0a0a0a;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .info-box {
            background: #f3f3f3;
            border-left: 4px solid #0a0a0a;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            color: #2a2a2a;
            margin-top: 15px;
        }

        .preview-frame {
            background: #f8f8f8;
            border: 1px solid #e2e2e2;
            border-radius: 12px;
            padding: 16px;
            min-height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .preview-frame img {
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid #d6d6d6;
            display: none;
            background: #ffffff;
        }

        .preview-frame.has-image img {
            display: block;
        }

        .preview-empty {
            font-size: 13px;
            color: #6b6b6b;
            text-align: center;
            max-width: 220px;
        }

        .preview-actions {
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 8px 12px;
            font-size: 12px;
            color: #6b6b6b;
        }

        .preview-actions span {
            flex: 1 1 220px;
            line-height: 1.4;
        }

        .preview-link {
            color: #0a0a0a;
            text-decoration: none;
            font-weight: 600;
            white-space: nowrap;
        }

        .preview-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 900px) {
            .layout {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 20px;
            }

            .parameters-grid {
                grid-template-columns: 1fr;
                min-height: 640px; /* Taller for single column layout */
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-link">
                ‚Üê Back to Models
            </a>
            <img class="header-logo" src="/images/logo.png" alt="Extrudo logo">
        </div>

        <div class="layout">
            <div class="panel">
                <div class="panel-header">Configuration</div>
                <p class="description">Welcome to the Extrudo drum modeler. We built this tool so you can quickly generate the exact shell geometry you need for your custom electronic drum kit. Just enter your desired dimensions and lug hole spacing to see a live preview. When everything looks perfect, hit generate to download a clean file that is ready for your printer.</p>

                <!-- Parameters Section -->
                <div class="section">
                    <div class="section-title">
                        <div class="section-icon">1</div>
                        Modify Parameters
                    </div>
                    <div class="parameters-grid" id="parametersGrid">
                        <!-- Will be filled by JavaScript -->
                    </div>
                </div>

                <!-- Submit Section -->
                <div class="section">
                    <div class="section-title">
                        <div class="section-icon">2</div>
                        Process Your Drum
                    </div>
                    <div class="button-group">
                        <button class="btn-submit" id="submitBtn">
                            Generate Modified Drum
                        </button>
                        <button class="btn-secondary" id="resetBtn">Reset Parameters</button>
                    </div>
                </div>

                <!-- Status Section -->
                <div class="status" id="status">
                    <div class="status-text" id="statusText"></div>
                    <div class="progress" id="progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                    <div id="statusDetails"></div>
                    <div id="downloadSection" style="display: none; margin-top: 15px;">
                        <button class="btn-submit" id="downloadBtn" style="width: 100%;">
                            Download Modified Drum File
                        </button>
                    </div>
                </div>

            </div>

            <div class="panel">
                <div class="panel-header">Preview</div>
                <div class="preview-frame" id="previewFrame">
                    <div class="preview-empty" id="previewEmpty">Loading preview...</div>
                    <img id="previewImage" alt="Modified drum preview">
                </div>
                <div class="preview-actions">
                    <span>Preview updates as you adjust parameters.</span>
                    <a id="previewLink" class="preview-link" href="#" target="_blank" rel="noopener" style="display:none;">Open full size</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let config = {};
        let currentJobId = null;
        let previewRefreshTimer = null;
        let previewObjectUrl = null;
        let previewRequestInFlight = false;
        let livePreviewDebounce = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            setupEventListeners();
            // Show live preview immediately
            updateLivePreview();
        });

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                config = await response.json();
                renderParameters();
            } catch (error) {
                console.error('Error loading config:', error);
                showStatus('Error loading configuration', 'error');
            }
        }

        function getParameters() {
            const parameters = {};
            for (const [key, param] of Object.entries(config.parameters)) {
                const input = document.getElementById(key);
                if (input) {
                    let value = input.value;
                    if (param.type === 'number') {
                        value = parseFloat(value);
                    } else if (param.type === 'dimension') {
                        // Append unit to numeric value for dimension fields
                        const numValue = parseFloat(value);
                        if (!isNaN(numValue)) {
                            value = `${numValue} ${param.unit}`;
                        }
                    }
                    parameters[key] = value;
                }
            }
            return parameters;
        }

        async function updateLivePreview() {
            if (previewRequestInFlight) return;
            previewRequestInFlight = true;

            const previewFrame = document.getElementById('previewFrame');
            const previewImage = document.getElementById('previewImage');
            const previewEmpty = document.getElementById('previewEmpty');

            try {
                const parameters = getParameters();
                const response = await fetch('/api/preview-svg', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ parameters })
                });

                if (!response.ok) {
                    throw new Error(`Preview fetch failed: ${response.status}`);
                }

                const blob = await response.blob();
                if (previewObjectUrl) {
                    URL.revokeObjectURL(previewObjectUrl);
                }
                previewObjectUrl = URL.createObjectURL(blob);
                previewImage.src = previewObjectUrl;
                previewFrame.classList.add('has-image');
                previewEmpty.style.display = 'none';
            } catch (error) {
                console.error('Error fetching live preview:', error);
                previewEmpty.textContent = 'Preview unavailable.';
                previewEmpty.style.display = 'block';
                previewFrame.classList.remove('has-image');
            } finally {
                previewRequestInFlight = false;
            }
        }

        function debouncedUpdatePreview() {
            if (livePreviewDebounce) {
                clearTimeout(livePreviewDebounce);
            }
            livePreviewDebounce = setTimeout(updateLivePreview, 150);
        }

        function renderParameters() {
            const grid = document.getElementById('parametersGrid');
            grid.innerHTML = '';

            const labelMap = {
                NumSegments: 'Number of Pieces',
                ShellThick: 'Shell thickness',
                ShellHeight: 'Shell height',
                ShellDiam: 'Shell diameter',
                LugTopDist: 'Lug offset from top',
                LugSpacing: 'Lug spacing',
                LapSizePercent: 'Lap size (%)',
                LugHoleDiam: 'Lug hole diameter'
            };

            const descriptionMap = {
                NumSegments: 'Number of pieces you will need to print and assemble to create the full drum shell. More segments can allow for larger drums on smaller printers, but may require more assembly.',
                ShellThick: 'Thickness of the drum shell wall.',
                ShellHeight: 'Total height of the drum shell from bottom to the peak of the bearing edge.',
                ShellDiam: 'Outer diameter of the drum shell, determining the overall size.',
                LugTopDist: 'Distance from the peak of the bearing edge to the center of the first lug mounting hole.',
                LugSpacing: 'Vertical spacing between lug mounting holes. This will determine the what type of size lugs you need to use.',
                LapSizePercent: 'Size of the lap joint as a percetage of the shell piece angle (e.g. 25% means the lap joint will cover 1/4 of the shell piece).',
                LugHoleDiam: 'Diameter of the holes for mounting tension lugs to the shell.'
            };

            for (const [key, param] of Object.entries(config.parameters)) {
                const group = document.createElement('div');
                group.className = 'parameter-group';
                const label = labelMap[key] || key;
                const description = descriptionMap[key] || '';
                
                // Determine input type and formatting based on parameter type
                const isNumeric = param.type === 'number' || param.type === 'dimension';
                const unitSuffix = param.unit ? `<span class="unit-suffix">${param.unit}</span>` : '';
                const defaultDisplay = param.unit ? `${param.default} ${param.unit}` : param.default;
                
                group.innerHTML = `
                    <label for="${key}" title="${description}">${label}</label>
                    <div class="input-with-unit">
                        <input 
                            type="text"
                            inputmode="${isNumeric ? 'decimal' : 'text'}"
                            id="${key}" 
                            value="${param.default}"
                            placeholder="${param.default}"
                            title="${description}"
                        >
                        ${unitSuffix}
                    </div>
                    <div class="parameter-note">Default: ${defaultDisplay}</div>
                `;
                grid.appendChild(group);

                // Add live preview update on input change
                const input = group.querySelector('input');
                
                // For number/dimension inputs, strip any non-numeric characters
                if (param.type === 'number' || param.type === 'dimension') {
                    input.addEventListener('input', (e) => {
                        // Allow only digits, decimal point, and minus sign at start
                        const cleaned = e.target.value.replace(/[^0-9.\-]/g, '')
                            .replace(/(?!^)-/g, '')  // minus only at start
                            .replace(/(\..*)\./g, '$1');  // only one decimal
                        if (cleaned !== e.target.value) {
                            e.target.value = cleaned;
                        }
                    });
                }
                
                input.addEventListener('input', debouncedUpdatePreview);
                input.addEventListener('change', debouncedUpdatePreview);
            }
        }

        function setupEventListeners() {
            const submitBtn = document.getElementById('submitBtn');
            const resetBtn = document.getElementById('resetBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const previewImage = document.getElementById('previewImage');
            const previewFrame = document.getElementById('previewFrame');
            const previewEmpty = document.getElementById('previewEmpty');

            previewImage.addEventListener('load', () => {
                previewFrame.classList.add('has-image');
                previewEmpty.style.display = 'none';
            });

            previewImage.addEventListener('error', () => {
                previewFrame.classList.remove('has-image');
                previewEmpty.style.display = 'block';
            });

            // Submit handling
            submitBtn.addEventListener('click', handleSubmit);
            resetBtn.addEventListener('click', handleReset);
            downloadBtn.addEventListener('click', handleDownload);
        }

        async function handleSubmit() {
            const parameters = getParameters();

            console.log('üì§ Sending parameters:', JSON.stringify(parameters, null, 2));
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            document.getElementById('downloadSection').style.display = 'none';

            try {
                showStatus('Submitting to Autodesk...', 'pending', true);

                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ parameters })
                });

                if (!response.ok) {
                    throw new Error(`Submission failed: ${response.statusText}`);
                }

                const data = await response.json();
                currentJobId = data.workItemId;

                showStatus(
                    `‚úì Job submitted! ID: <div class="status-id">${currentJobId}</div>
                    Processing... (this may take 2-5 minutes)`,
                    'pending',
                    true
                );

                // Poll for status
                pollJobStatus();
            } catch (error) {
                console.error('Error submitting job:', error);
                showStatus(`Submission error: ${error.message}`, 'error');
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
            }
        }

        async function pollJobStatus() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/api/job-status/${currentJobId}`);
                if (!response.ok) throw new Error('Failed to get status');

                const data = await response.json();

                // Update progress bar if available
                if (data.progress !== undefined) {
                    const progressFill = document.querySelector('.progress-fill');
                    if (progressFill) {
                        progressFill.style.width = `${data.progress}%`;
                    }
                }

                if (data.status === 'success') {
                    showStatus(
                        '‚úì Processing complete! Your modified drum parameters have been applied.',
                        'success'
                    );
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').classList.remove('loading');
                    document.getElementById('downloadSection').style.display = 'block';
                    showPreview(currentJobId);
                } else if (data.status === 'failed' || data.status === 'cancelled') {
                    showStatus(`‚úó Job ${data.status}. Please try again.`, 'error');
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').classList.remove('loading');
                    clearPreviewRefresh();
                } else {
                    // Still pending - update status message
                    const progressPercent = data.progress !== undefined ? ` ${data.progress}%` : '';
                    showStatus(
                        `‚è≥ Processing...${progressPercent}<br><small>Job ID: ${currentJobId}</small>`,
                        'pending',
                        true
                    );
                    // Check again in 1 second
                    setTimeout(pollJobStatus, 1000);
                }
            } catch (error) {
                console.error('Error polling status:', error);
                // Continue polling on error
                setTimeout(pollJobStatus, 2000);
            }
        }

        function handleReset() {
            currentJobId = null;
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').classList.remove('loading');
            document.getElementById('status').classList.remove('show');
            document.getElementById('downloadSection').style.display = 'none';
            if (previewObjectUrl) {
                URL.revokeObjectURL(previewObjectUrl);
                previewObjectUrl = null;
            }
            document.getElementById('previewLink').setAttribute('href', '#');
            document.getElementById('previewLink').style.display = 'none';
            clearPreviewRefresh();
            renderParameters();
            // Refresh live preview with default values
            updateLivePreview();
        }

        function clearPreviewRefresh() {
            if (previewRefreshTimer) {
                clearInterval(previewRefreshTimer);
                previewRefreshTimer = null;
            }
        }

        async function updatePreviewImage(baseUrl) {
            if (previewRequestInFlight) return;
            previewRequestInFlight = true;

            const previewFrame = document.getElementById('previewFrame');
            const previewImage = document.getElementById('previewImage');
            const previewEmpty = document.getElementById('previewEmpty');

            try {
                const response = await fetch(`${baseUrl}?t=${Date.now()}`, { cache: 'no-store' });
                if (!response.ok) {
                    throw new Error(`Preview fetch failed: ${response.status}`);
                }

                const contentType = response.headers.get('content-type') || '';
                const blob = await response.blob();

                if (previewObjectUrl) {
                    URL.revokeObjectURL(previewObjectUrl);
                }

                previewObjectUrl = URL.createObjectURL(blob);
                previewImage.src = previewObjectUrl;
                previewImage.dataset.contentType = contentType;
                previewFrame.classList.add('has-image');
                previewEmpty.style.display = 'none';

                if (!contentType.includes('svg')) {
                    clearPreviewRefresh();
                }
            } catch (error) {
                console.error('Error fetching preview:', error);
            } finally {
                previewRequestInFlight = false;
            }
        }

        function showPreview(jobId) {
            const previewLink = document.getElementById('previewLink');
            const baseUrl = `/api/preview/${jobId}`;

            previewLink.href = `${baseUrl}?full=1`;
            previewLink.style.display = 'inline';

            clearPreviewRefresh();
            // Refresh the preview from the job endpoint
            updatePreviewImage(baseUrl);
        }

        async function handleDownload() {
            if (!currentJobId) {
                showStatus('No job ID available for download', 'error');
                return;
            }

            try {
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.disabled = true;
                downloadBtn.classList.add('loading');
                downloadBtn.textContent = '‚¨áÔ∏è Downloading...'

                const response = await fetch(`/api/download/${currentJobId}`);
                if (!response.ok) {
                    throw new Error(`Download failed: ${response.statusText}`);
                }

                // Get filename from response header or use default
                const contentDisposition = response.headers.get('content-disposition');
                let filename = 'modified_drum.f3d';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                    if (filenameMatch) filename = filenameMatch[1];
                }

                // Convert response to blob and trigger download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                downloadBtn.disabled = false;
                downloadBtn.classList.remove('loading');
                downloadBtn.textContent = '‚¨áÔ∏è Download Modified Drum File';
            } catch (error) {
                console.error('Error downloading file:', error);
                showStatus(`Download error: ${error.message}`, 'error');
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.disabled = false;
                downloadBtn.classList.remove('loading');
                downloadBtn.textContent = '‚¨áÔ∏è Download Modified Drum File';
            }
        }

        function showStatus(message, type, showProgress = false) {
            const status = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            const progress = document.getElementById('progress');

            status.className = `status show ${type}`;
            statusText.innerHTML = message;
            progress.style.display = showProgress ? 'block' : 'none';
        }

        // Auto-reload when server restarts (dev mode only)
        // Requires multiple consecutive failures to avoid false positives during navigation
        let serverDownCount = 0;
        const REQUIRED_DOWN_COUNT = 3; // Must fail 3 times in a row (1.5 seconds)
        
        setInterval(async () => {
            // Don't poll when page is hidden (user navigated away)
            if (document.hidden) {
                serverDownCount = 0;
                return;
            }
            
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    if (serverDownCount >= REQUIRED_DOWN_COUNT) {
                        console.log('Server is back online, reloading page...');
                        window.location.reload();
                    }
                    serverDownCount = 0;
                } else {
                    serverDownCount++;
                }
            } catch (error) {
                serverDownCount++;
            }
        }, 500); // Check every 500ms

        // Fade in page once loaded to avoid layout shift flash
        window.addEventListener('load', () => {
            document.body.classList.add('loaded');
        });
        // Fallback in case load event already fired
        if (document.readyState === 'complete') {
            document.body.classList.add('loaded');
        }
    </script>
</body>
</html>
